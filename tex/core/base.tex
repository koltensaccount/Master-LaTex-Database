% ====================================================
% CORE: Shared Packages & Macros
% ----------------------------------------------------
% These resources are used by both the textbook-style notes
% and the printable homework documents.
% ====================================================
\providecommand{\TexRoot}{}

% --- CORE: Foundational packages ---
\usepackage{amsmath,amssymb,amsthm,amsfonts,amscd}
\usepackage{mathtools}
\usepackage{enumitem}
\usepackage{needspace}
\usepackage{xstring}
\usepackage{xparse}
\usepackage{float}
\usepackage{cancel}
\usepackage[superscript]{cite}
\usepackage{changepage}
\usepackage{soul}
\usepackage{tocloft}
\usepackage{hyperref}
\usepackage[capitalise,nameinlink]{cleveref}

\makeatletter
\g@addto@macro\UrlBreaks{%
  \do\/\do\\\do\_\do\-\do\{\do\}%
  \do\.\do:\do\=\do+\do\#\do\&\do\,\do\?%
}
\makeatother

\newcommand{\MathNotesSlugSet}[2]{%
  \begingroup
    \edef\MathNotesSlugTmp{\detokenize{#2}}%
    \lowercase{\edef\MathNotesSlugTmp{\MathNotesSlugTmp}}%
    \StrSubstitute{\MathNotesSlugTmp}{ }{-}[\MathNotesSlugTmp]%
    \StrSubstitute{\MathNotesSlugTmp}{~}{-}[\MathNotesSlugTmp]%
    \StrSubstitute{\MathNotesSlugTmp}{:}{-}[\MathNotesSlugTmp]%
    \StrSubstitute{\MathNotesSlugTmp}{/}{-}[\MathNotesSlugTmp]%
    \StrSubstitute{\MathNotesSlugTmp}{(}{}[\MathNotesSlugTmp]%
    \StrSubstitute{\MathNotesSlugTmp}{)}{}[\MathNotesSlugTmp]%
    \StrSubstitute{\MathNotesSlugTmp}{,}{}[\MathNotesSlugTmp]%
    \StrSubstitute{\MathNotesSlugTmp}{.}{}[\MathNotesSlugTmp]%
    \StrSubstitute{\MathNotesSlugTmp}{--}{-}[\MathNotesSlugTmp]%
    \StrSubstitute{\MathNotesSlugTmp}{--}{-}[\MathNotesSlugTmp]%
    \StrSubstitute{\MathNotesSlugTmp}{--}{-}[\MathNotesSlugTmp]%
    \xdef#1{\MathNotesSlugTmp}%
  \endgroup
}

% --- CORE: Graphics and plotting ---
\usepackage{graphicx}
\usepackage{physics}
\usepackage{tikz}
\usepackage{circuitikz}
\usetikzlibrary{calc,positioning,shapes.geometric,patterns,snakes,arrows.meta,patterns.meta,matrix}
\usepackage{pgfplots}
\pgfplotsset{compat=1.18}
\usepgfplotslibrary{groupplots}
\usepackage[outline]{contour}

% --- CORE: Box/enclosure support ---
\usepackage[most]{tcolorbox}

% --- CORE: Math shorthands ---
\makeatletter
\@ifundefined{vect}{\newcommand{\vect}[1]{\mathbf{#1}}}{}%
\@ifundefined{mat}{\newcommand{\mat}[1]{\begin{bmatrix}#1\end{bmatrix}}}{}%
\@ifundefined{R}{\newcommand{\R}{\mathbb{R}}}{}%
\@ifundefined{rank}{\newcommand{\rank}{\operatorname{rank}}}{}%
\@ifundefined{nulls}{\newcommand{\nulls}{\operatorname{null}}}{}%
\@ifundefined{Span}{\newcommand{\Span}{\operatorname{span}}}{}%
\@ifundefined{eig}{\newcommand{\eig}{\operatorname{eig}}}{}%
\@ifundefined{diff}{\newcommand{\diff}{\mathrm{d}}}{}%
\makeatother

% --- CORE: Box/enclosure support ---
\usepackage[most]{tcolorbox}

% --- CORE: Table enhancements ---
\usepackage{booktabs} % For \toprule, \midrule, \bottomrule
\usepackage{arydshln} % For \hdashline (dashed table lines)

% Custom line settings for truth tables
\setlength\dashlinedash{0.2pt}
\setlength\dashlinegap{1.5pt}
\setlength\arrayrulewidth{0.3pt}

% --- CORE: Math shorthands ---
\makeatletter
\@ifundefined{vect}{\newcommand{\vect}[1]{\mathbf{#1}}}{}%

% --- CORE: Structural theorem environments ---
\theoremstyle{definition}
\newtheorem{definition}{Definition}[section]
\newtheorem{theorem}{Theorem}[section]
\newtheorem{example}{Example}[section]

% --- CORE: Homework problem + solution boxes ---
\newcounter{hwproblem}
\newcounter{discproblem}

\crefname{hwproblem}{Problem}{Problems}
\Crefname{hwproblem}{Problem}{Problems}
\crefname{discproblem}{Problem}{Problems}
\Crefname{discproblem}{Problem}{Problems}

\newcommand{\MathIfBlankTF}[3]{%
  \if\relax\detokenize{#1}\relax
    #2%
  \else
    #3%
  \fi
}

\makeatletter
\newcommand{\CurrentHomeworkSection}{}
\NewDocumentCommand{\HomeworkSection}{m}{%
  \section*{Section~#1}%
  \def\CurrentHomeworkSection{#1}%
}

\NewDocumentEnvironment{hwproblem}{O{} m O{}}{%
  \def\hwproblem@section{#1}%
  \def\hwproblem@number{#2}%
  \def\hwproblem@title{#3}%
  \Needspace{6\baselineskip}%
  \par\vspace{0.5em}%
  \begin{samepage}%
  \begin{adjustwidth}{2em}{0em}%
  \refstepcounter{hwproblem}%
  \edef\hwproblem@label{prob:hw-\hwproblem@section-\hwproblem@number}%
  \edef\@currentlabel{HW~\hwproblem@section.\hwproblem@number}%
  \MathIfBlankTF{#3}{%
    \protected@edef\@currentlabelname{Problem~HW~\hwproblem@section.\hwproblem@number}%
  }{%
    \protected@edef\@currentlabelname{Problem~HW~\hwproblem@section.\hwproblem@number~(#3)}%
  }%
  \phantomsection
  \label{\hwproblem@label}%
  \MathIfBlankTF{#3}{%
    \noindent\textbf{Problem\ \hwproblem@number}%
  }{%
    \noindent\textbf{Problem\ \hwproblem@number\ \textemdash\ #3}%
  }%
  \par\vspace{0.5em}%
  \setlength{\parindent}{0pt}%
}{%
  \end{adjustwidth}%
  \end{samepage}%
  \vspace{1em}%
}

\NewDocumentEnvironment{discproblem}{O{} m O{}}{%
  \def\discproblem@pack{#1}%
  \def\discproblem@id{#2}%
  \def\discproblem@topic{#3}%
  \Needspace{6\baselineskip}%
  \par\vspace{0.5em}%
  \begin{samepage}%
  \begin{adjustwidth}{2em}{0em}%
  \refstepcounter{discproblem}%
  \edef\discproblem@label{prob:disc-\discproblem@pack-\discproblem@id}%
  \edef\@currentlabel{Disc~\discproblem@pack.\discproblem@id}%
  \MathIfBlankTF{#3}{%
    \protected@edef\@currentlabelname{Problem~Disc~\discproblem@pack.\discproblem@id}%
  }{%
    \protected@edef\@currentlabelname{Problem~Disc~\discproblem@pack.\discproblem@id~(#3)}%
  }%
  \phantomsection
  \label{\discproblem@label}%
  \noindent\textbf{Disc\ \discproblem@pack\ \textbullet{}\ Problem\ \discproblem@id}%
  \MathIfBlankTF{#3}{}{%
    \ \textemdash\ #3%
  }%
  \par\vspace{0.5em}%
  \setlength{\parindent}{0pt}%
}{%
  \end{adjustwidth}%
  \end{samepage}%
  \vspace{1em}%
}

\newenvironment{solution}{%
  \par\vspace{0.25em}\noindent\textbf{Solution. }\setlength{\parindent}{0pt}\ignorespaces
}{\par\vspace{0.5em}}

\newcommand{\probref}[1]{\cref{#1}}
\newcommand{\Probref}[1]{\Cref{#1}}

\NewDocumentCommand{\newhwprob}{m m O{}}{\begin{hwproblem}[#1]{#2}[#3]}
\NewDocumentCommand{\newdiscprob}{m m O{}}{\begin{discproblem}[#1]{#2}[#3]}
\NewDocumentEnvironment{autohwproblem}{m O{}}{%
  \begin{hwproblem}[\CurrentHomeworkSection]{#1}[#2]
}{%
  \end{hwproblem}
}
\makeatother

\newenvironment{textbookproblem}[1][]{
  \Needspace{6\baselineskip}%
  \par\vspace{0.5em}%
  \begin{samepage}
  \begin{adjustwidth}{2em}{0em}%
  \noindent\textbf{#1}\par\vspace{0.5em}%
  \setlength{\parindent}{0pt}%
}{
  \end{adjustwidth}
  \end{samepage}
  \vspace{1em}%
}

\newtcolorbox{solutionbox}{
  enhanced,
  breakable,
  colback=white,
  colframe=black!15,
  borderline west={3pt}{0pt}{Primary},
  sharp corners,
  boxrule=0pt,
  left=10pt, right=10pt, top=6pt, bottom=8pt,
  before skip=10pt, after skip=10pt,
  title={},
  fontupper=\normalsize,
  before upper={%
    \parindent=0pt\setlength{\emergencystretch}{2em}\setlength{\arraycolsep}{4pt}%
    \textcolor{black}{\textbf{Solution}}\par\medskip
  },
}


% K-map macros
% isolated term
\newcommand{\implicantsol}[3][0]{%
  \draw[rounded corners=3pt, fill=#3, opacity=0.3, draw=none] ($(#2.north west)+(135:#1)$) rectangle ($(#2.south east)+(-45:#1)$);
}

% internal group
\newcommand{\implicant}[4][0]{%
  \draw[rounded corners=3pt, fill=#4, opacity=0.3, draw=none] ($(#2.north west)+(135:#1)$) rectangle ($(#3.south east)+(-45:#1)$);
}

% lateral borders
\newcommand{\implicantcostats}[4][0]{%
  \draw[rounded corners=3pt, fill=#4, opacity=0.3, draw=none] ($(rf.east |- #2.north)+(90:#1)$)-| ($(#2.east)+(0:#1)$) |- ($(rf.east |- #3.south)+(-90:#1)$);
  \draw[rounded corners=3pt, fill=#4, opacity=0.3, draw=none] ($(cf.west |- #2.north)+(90:#1)$) -| ($(#3.west)+(180:#1)$) |- ($(cf.west |- #3.south)+(-90:#1)$);
}

% top-bottom borders
\newcommand{\implicantdaltbaix}[4][0]{%
  \draw[rounded corners=3pt, fill=#4, opacity=0.3, draw=none] ($(cf.south -| #2.west)+(180:#1)$) |- ($(#2.south)+(-90:#1)$) -| ($(cf.south -| #3.east)+(0:#1)$);
  \draw[rounded corners=3pt, fill=#4, opacity=0.3, draw=none] ($(rf.north -| #2.west)+(180:#1)$) |- ($(#3.north)+(90:#1)$) -| ($(rf.north -| #3.east)+(0:#1)$);
}

%group corners
%#1 - Optional. Space between node and grouping line. Default=0
%#2 - filling color
\newcommand{\implicantcantons}[2][0]{
    \draw[rounded corners=3pt, opacity=0] ($(rf.east |- 0.south)+(-90:#1)$) -| ($(0.east |- cf.south)+(0:#1)$);
    \draw[rounded corners=3pt, opacity=0] ($(rf.east |- 8.north)+(90:#1)$) -| ($(8.east |- rf.north)+(0:#1)$);
    \draw[rounded corners=3pt, opacity=0] ($(cf.west |- 2.south)+(-90:#1)$) -| ($(2.west |- cf.south)+(180:#1)$);
    \draw[rounded corners=3pt, opacity=0] ($(cf.west |- 10.north)+(90:#1)$) -| ($(10.west |- rf.north)+(180:#1)$);
    \fill[rounded corners=3pt, fill=#2, opacity=.3] ($(rf.east |- 0.south)+(-90:#1)$) -|  ($(0.east |- cf.south)+(0:#1)$) [sharp corners] ($(rf.east |- 0.south)+(-90:#1)$) |-  ($(0.east |- cf.south)+(0:#1)$) ;
    \fill[rounded corners=3pt, fill=#2, opacity=.3] ($(rf.east |- 8.north)+(90:#1)$) -| ($(8.east |- rf.north)+(0:#1)$) [sharp corners] ($(rf.east |- 8.north)+(90:#1)$) |- ($(8.east |- rf.north)+(0:#1)$) ;
    \fill[rounded corners=3pt, fill=#2, opacity=.3] ($(cf.west |- 2.south)+(-90:#1)$) -| ($(2.west |- cf.south)+(180:#1)$) [sharp corners]($(cf.west |- 2.south)+(-90:#1)$) |- ($(2.west |- cf.south)+(180:#1)$) ;
    \fill[rounded corners=3pt, fill=#2, opacity=.3] ($(cf.west |- 10.north)+(90:#1)$) -| ($(10.west |- rf.north)+(180:#1)$) [sharp corners] ($(cf.west |- 10.north)+(90:#1)$) |- ($(10.west |- rf.north)+(180:#1)$) ;
}

% 4×4
\newenvironment{Karnaugh}{%
\begin{tikzpicture}[baseline=(current bounding box.north),scale=0.8]
\draw (0,0) grid (4,4);
\draw (0,4) -- node [pos=0.7,above right,anchor=south west] {cd} node [pos=0.7,below left,anchor=north east] {ab} ++(135:1);
\matrix (mapa) [matrix of nodes,column sep={0.8cm,between origins},row sep={0.8cm,between origins},every node/.style={minimum size=0.3mm},anchor=8.center,ampersand replacement=\&] at (0.5,0.5)
{
                       \& |(c00)| 00         \& |(c01)| 01         \& |(c11)| 11         \& |(c10)| 10         \& |(cf)| \phantom{00} \\
|(r00)| 00             \& |(0)|  \phantom{0} \& |(1)|  \phantom{0} \& |(3)|  \phantom{0} \& |(2)|  \phantom{0} \&                     \\
|(r01)| 01             \& |(4)|  \phantom{0} \& |(5)|  \phantom{0} \& |(7)|  \phantom{0} \& |(6)|  \phantom{0} \&                     \\
|(r11)| 11             \& |(12)| \phantom{0} \& |(13)| \phantom{0} \& |(15)| \phantom{0} \& |(14)| \phantom{0} \&                     \\
|(r10)| 10             \& |(8)|  \phantom{0} \& |(9)|  \phantom{0} \& |(11)| \phantom{0} \& |(10)| \phantom{0} \&                     \\
|(rf) | \phantom{00}   \&                    \&                    \&                    \&                    \&                     \\
};
}{\end{tikzpicture}}

% 2×4
\newenvironment{Karnaughvuit}{%
\begin{tikzpicture}[baseline=(current bounding box.north),scale=0.8]
\draw (0,0) grid (4,2);
\draw (0,2) -- node [pos=0.7,above right,anchor=south west] {bc} node [pos=0.7,below left,anchor=north east] {a} ++(135:1);
\matrix (mapa) [matrix of nodes,column sep={0.8cm,between origins},row sep={0.8cm,between origins},every node/.style={minimum size=0.3mm},anchor=4.center,ampersand replacement=\&] at (0.5,0.5)
{
                      \& |(c00)| 00         \& |(c01)| 01         \& |(c11)| 11         \& |(c10)| 10         \& |(cf)| \phantom{00} \\
|(r00)| 0             \& |(0)|  \phantom{0} \& |(1)|  \phantom{0} \& |(3)|  \phantom{0} \& |(2)|  \phantom{0} \&                     \\
|(r01)| 1             \& |(4)|  \phantom{0} \& |(5)|  \phantom{0} \& |(7)|  \phantom{0} \& |(6)|  \phantom{0} \&                     \\
|(rf) | \phantom{00}  \&                    \&                    \&                    \&                    \&                     \\
};
}{\end{tikzpicture}}

% 2×2
\newenvironment{Karnaughquatre}{%
\begin{tikzpicture}[baseline=(current bounding box.north),scale=0.8]
\draw (0,0) grid (2,2);
\draw (0,2) -- node [pos=0.7,above right,anchor=south west] {b} node [pos=0.7,below left,anchor=north east] {a} ++(135:1);
\matrix (mapa) [matrix of nodes,column sep={0.8cm,between origins},row sep={0.8cm,between origins},every node/.style={minimum size=0.3mm},anchor=2.center,ampersand replacement=\&] at (0.5,0.5)
{
          \& |(c00)| 0          \& |(c01)| 1  \\
|(r00)| 0 \& |(0)|  \phantom{0} \& |(1)|  \phantom{0} \\
|(r01)| 1 \& |(2)|  \phantom{0} \& |(3)|  \phantom{0} \\
};
}{\end{tikzpicture}}

% content helpers
\newcommand{\contingut}[1]{\foreach \x [count=\xi from 0]  in {#1} \path (\xi) node {\x};}
\newcommand{\minterms}[1]{\foreach \x in {#1} \path (\x) node {1};}
\newcommand{\maxterms}[1]{\foreach \x in {#1} \path (\x) node {0};}
\newcommand{\indeterminats}[1]{\foreach \x in {#1} \path (\x) node {X};}

% --- CORE: Utility macros shared across styles ---
\newcommand{\keyword}[1]{\textbf{#1}}
\newcommand{\bluearrow}{\textcolor{Primary}{\large\(\blacktriangleright\)}\;}

\input{\TexRoot core/tikz-springs}
